ARG PYTHON_VERSION=3.10
FROM python:${PYTHON_VERSION} AS foundation

RUN apt-get update && \
  apt-get install -y build-essential curl wget cmake && \
  apt-get clean && rm -rf /var/lib/apt/lists/*

RUN python -m pip install --upgrade pip

RUN mkdir -p /opt/workflow_orchestration/repo

COPY datalake_flow.py model_flow.py /opt/workflow_orchestration/repo/
COPY pyproject.toml poetry.toml poetry.lock /opt/workflow_orchestration/repo/

WORKDIR /opt/workflow_orchestration/repo

RUN curl -sSL https://install.python-poetry.org | python3 - && \
  export PATH=$PATH:$HOME/.local/bin && \
  poetry --version && \
  poetry install --no-dev

# RUN pip install \
#     mlflow \
#     pymysql \
#     boto3 & \
#     mkdir /mlflow/

RUN mkdir /mlflow/

FROM python:${PYTHON_VERSION}-slim
COPY --from=foundation /opt/workflow_orchestration/repo /opt/workflow_orchestration/repo
ENV PATH=/opt/workflow_orchestration/repo/.venv/bin:$PATH

ENV PYTHONUNBUFFERED 1
WORKDIR /opt/workflow_orchestration/repo

EXPOSE 5000

## Environment variables made available through the Fargate task.
## Do not enter values
CMD mlflow server \
    --host 0.0.0.0 \
    --port 5000 \
    --default-artifact-root ${BUCKET} \
    --backend-store-uri mysql+pymysql://${USERNAME}:${PASSWORD}@${HOST}:${PORT}/${DATABASE}


# CMD ["mlflow", "server", "--host" "0.0.0.0", "--port", "5000", "fastapi_app:app"]
